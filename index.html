<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admazing — 2025 US Campaign Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0D0D0D; --card: #1A1A1A; --card2: #141414;
      --purple: #7B42F6; --purple-lt: #9D6FF8;
      --white: #FFFFFF; --gray: #AAAAAA; --line: #2A2A2A;
      --green: #22C55E; --orange: #F59E0B; --red: #EF4444;
    }
    body { background: var(--bg); color: var(--white); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-height: 100vh; }
    .topbar { height: 4px; background: var(--purple); }
    header { display: flex; align-items: center; justify-content: space-between; padding: 20px 32px; border-bottom: 1px solid var(--line); flex-wrap: wrap; gap: 12px; }
    .logo { font-size: 13px; font-weight: 700; color: var(--purple); letter-spacing: 2px; }
    .header-title h1 { font-size: 20px; font-weight: 700; }
    .header-title p { font-size: 13px; color: var(--gray); margin-top: 2px; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    #last-updated { font-size: 12px; color: var(--gray); }
    .btn-refresh { background: var(--purple); color: #fff; border: none; padding: 8px 18px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
    .btn-refresh:hover { background: var(--purple-lt); }
    .filters { display: flex; gap: 12px; padding: 16px 32px; background: var(--card2); border-bottom: 1px solid var(--line); flex-wrap: wrap; align-items: center; }
    .filter-label { font-size: 12px; color: var(--gray); }
    select { background: var(--card); color: var(--white); border: 1px solid var(--line); padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; }
    select:focus { outline: none; border-color: var(--purple); }
    main { padding: 28px 32px; max-width: 1400px; margin: 0 auto; }
    .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
    .kpi { background: var(--card); border-radius: 10px; padding: 20px 24px; border: 1px solid var(--line); }
    .kpi-val { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .kpi-lbl { font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; }
    .kpi-sub { font-size: 11px; color: var(--purple-lt); margin-top: 6px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .card { background: var(--card); border-radius: 10px; border: 1px solid var(--line); padding: 20px 24px; }
    .card h2 { font-size: 11px; font-weight: 700; color: var(--purple); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 16px; }
    .exec-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .exec-name { font-size: 13px; width: 160px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .exec-bar-wrap { flex: 1; background: var(--line); border-radius: 4px; height: 22px; overflow: hidden; }
    .exec-bar { height: 100%; background: var(--purple); border-radius: 4px; transition: width 0.6s ease; }
    .exec-rev { font-size: 12px; color: var(--gray); width: 90px; text-align: right; flex-shrink: 0; }
    .exec-cnt { font-size: 11px; color: var(--gray); width: 60px; text-align: right; flex-shrink: 0; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
    thead tr { border-bottom: 1px solid var(--purple); }
    th { text-align: left; padding: 8px 12px; font-size: 11px; color: var(--gray); font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; }
    tbody tr { border-bottom: 1px solid var(--line); transition: background 0.15s; }
    tbody tr:hover { background: rgba(123,66,246,0.06); }
    td { padding: 9px 12px; vertical-align: middle; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-finished { background: rgba(34,197,94,0.15); color: var(--green); }
    .badge-cancelled { background: rgba(239,68,68,0.15); color: var(--red); }
    .badge-na { background: rgba(170,170,170,0.15); color: var(--gray); }
    .text-right { text-align: right; }
    .text-purple { color: var(--purple-lt); font-weight: 600; }
    .pagination { display: flex; align-items: center; justify-content: space-between; margin-top: 16px; font-size: 12px; color: var(--gray); }
    .page-btns { display: flex; gap: 8px; }
    .page-btn { background: var(--card2); color: var(--white); border: 1px solid var(--line); padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; }
    .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .page-btn:not(:disabled):hover { border-color: var(--purple); }
    .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; gap: 16px; }
    .spinner { width: 36px; height: 36px; border: 3px solid var(--line); border-top-color: var(--purple); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .chart-wrap { position: relative; height: 220px; }
    .token-prompt { background: var(--card); border: 1px solid var(--purple); border-radius: 10px; padding: 32px; max-width: 480px; margin: 80px auto; text-align: center; }
    .token-prompt h2 { color: var(--purple); margin-bottom: 12px; font-size: 16px; }
    .token-prompt p { color: var(--gray); font-size: 13px; margin-bottom: 20px; }
    .token-input { width: 100%; background: var(--card2); border: 1px solid var(--line); color: var(--white); padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-bottom: 12px; }
    .token-input:focus { outline: none; border-color: var(--purple); }
    @media (max-width: 900px) {
      .kpis { grid-template-columns: repeat(2,1fr); }
      .grid-2 { grid-template-columns: 1fr; }
      main { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="topbar"></div>
  <header>
    <div class="logo">ADMAZING</div>
    <div class="header-title">
      <h1>2025 US Campaign Dashboard</h1>
      <p>United States · Boltflow Operations · Live Data</p>
    </div>
    <div class="header-right">
      <span id="last-updated"></span>
      <button class="btn-refresh" onclick="loadData()">↻ Refresh</button>
    </div>
  </header>
  <div class="filters">
    <span class="filter-label">Filter:</span>
    <select id="filter-exec" onchange="applyFilters()"><option value="">All Executives</option></select>
    <select id="filter-quarter" onchange="applyFilters()">
      <option value="">All Quarters</option>
      <option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option>
    </select>
    <select id="filter-status" onchange="applyFilters()">
      <option value="">All Statuses</option>
      <option>Finished</option><option>Cancelled</option>
    </select>
  </div>
  <main id="main-content">
    <div class="loading"><div class="spinner"></div><span style="color:var(--gray)">Loading...</span></div>
  </main>

  <script>
    const BASE_ID = 'appz5sk9uwq3rIH6y';
    const TABLE_ID = 'tblEKPHPZIBIAU5w6';
    // Token stored in sessionStorage so it never touches the repo
    let AT_TOKEN = sessionStorage.getItem('at_token') || '';

    let allRecords = [], filteredRecords = [], currentPage = 1;
    const PAGE_SIZE = 20;

    function getQuarter(d) {
      if (!d) return 'Unknown';
      const m = parseInt(d.slice(5,7));
      return m<=3?'Q1':m<=6?'Q2':m<=9?'Q3':'Q4';
    }

    async function fetchAll() {
      let records = [], offset = null;
      const fields = ['Campaign Name','Client Partner Name','Campaign Start Date','Campaign End Date','Country','Gross Sale (USD)','Main Project Status'];
      const filter = encodeURIComponent("AND(IS_AFTER({Campaign Start Date},'2024-12-31'),IS_BEFORE({Campaign Start Date},'2026-01-01'))");
      const fp = fields.map(f=>`fields[]=${encodeURIComponent(f)}`).join('&');
      do {
        const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}?${fp}&filterByFormula=${filter}&pageSize=100${offset?'&offset='+offset:''}`;
        const res = await fetch(url, { headers: { Authorization: `Bearer ${AT_TOKEN}` } });
        if (!res.ok) throw new Error('Auth failed');
        const data = await res.json();
        records = records.concat(data.records||[]);
        offset = data.offset;
      } while (offset);
      return records;
    }

    async function loadData() {
      if (!AT_TOKEN) { showTokenPrompt(); return; }
      document.getElementById('main-content').innerHTML = '<div class="loading"><div class="spinner"></div><span style="color:var(--gray)">Loading campaign data...</span></div>';
      try {
        const raw = await fetchAll();
        allRecords = raw.map(r=>({...r.fields, quarter: getQuarter(r.fields['Campaign Start Date'])}))
          .filter(r=>(r['Country']||[]).some(c=>c&&c.includes('United States')));
        const execs = [...new Set(allRecords.map(r=>(r['Client Partner Name']||['Unknown'])[0]))].sort();
        const sel = document.getElementById('filter-exec');
        sel.innerHTML = '<option value="">All Executives</option>'+execs.map(e=>`<option>${e}</option>`).join('');
        document.getElementById('last-updated').textContent = 'Updated '+new Date().toLocaleTimeString();
        applyFilters();
      } catch(e) {
        AT_TOKEN = ''; sessionStorage.removeItem('at_token'); showTokenPrompt('Invalid token. Please try again.');
      }
    }

    function showTokenPrompt(err='') {
      document.getElementById('main-content').innerHTML = `
        <div class="token-prompt">
          <h2>Connect to Airtable</h2>
          <p>Enter your Airtable Personal Access Token to load live campaign data.${err?'<br><span style="color:var(--red)">'+err+'</span>':''}</p>
          <input class="token-input" id="token-input" type="password" placeholder="patxxxxxxxx..." />
          <button class="btn-refresh" style="width:100%" onclick="saveToken()">Connect</button>
        </div>`;
    }

    function saveToken() {
      const t = document.getElementById('token-input').value.trim();
      if (!t) return;
      AT_TOKEN = t;
      sessionStorage.setItem('at_token', t);
      loadData();
    }

    function applyFilters() {
      const exec = document.getElementById('filter-exec').value;
      const quarter = document.getElementById('filter-quarter').value;
      const status = document.getElementById('filter-status').value;
      filteredRecords = allRecords.filter(r => {
        const e = (r['Client Partner Name']||['Unknown'])[0];
        const s = r['Main Project Status']||'';
        return (!exec||e===exec)&&(!quarter||r.quarter===quarter)&&(!status||s===status);
      });
      currentPage = 1;
      render();
    }

    function render() {
      const records = filteredRecords;
      const totalRev = records.reduce((s,r)=>s+(r['Gross Sale (USD)']||0),0);
      const finished = records.filter(r=>r['Main Project Status']==='Finished').length;
      const byExec = {};
      records.forEach(r=>{const e=(r['Client Partner Name']||['Unknown'])[0];if(!byExec[e])byExec[e]={count:0,revenue:0};byExec[e].count++;byExec[e].revenue+=r['Gross Sale (USD)']||0;});
      const execSorted = Object.entries(byExec).sort((a,b)=>b[1].revenue-a[1].revenue);
      const byQ={Q1:0,Q2:0,Q3:0,Q4:0};
      records.forEach(r=>{if(byQ[r.quarter]!==undefined)byQ[r.quarter]+=r['Gross Sale (USD)']||0;});
      const byStatus={};
      records.forEach(r=>{const s=r['Main Project Status']||'N/A';byStatus[s]=(byStatus[s]||0)+1;});

      document.getElementById('main-content').innerHTML = `
        <div class="kpis">
          <div class="kpi"><div class="kpi-val">${records.length}</div><div class="kpi-lbl">Total Projects</div><div class="kpi-sub">${finished} finished</div></div>
          <div class="kpi"><div class="kpi-val" style="color:var(--purple)">$${(totalRev/1e6).toFixed(1)}M</div><div class="kpi-lbl">Total Revenue</div><div class="kpi-sub">USD Gross</div></div>
          <div class="kpi"><div class="kpi-val">${Object.keys(byExec).length}</div><div class="kpi-lbl">Sales Executives</div><div class="kpi-sub">Active in period</div></div>
          <div class="kpi"><div class="kpi-val">$${records.length?(totalRev/records.length/1000).toFixed(0):0}K</div><div class="kpi-lbl">Avg Project Value</div><div class="kpi-sub">Per campaign</div></div>
        </div>
        <div class="grid-2">
          <div class="card"><h2>Revenue by Quarter</h2><div class="chart-wrap"><canvas id="qChart"></canvas></div></div>
          <div class="card"><h2>Project Status</h2><div class="chart-wrap"><canvas id="sChart"></canvas></div></div>
        </div>
        <div class="card" style="margin-bottom:24px"><h2>Revenue by Sales Executive</h2><div id="exec-bars"></div></div>
        <div class="card">
          <h2>All Projects</h2>
          <div class="table-wrap"><table>
            <thead><tr><th>Campaign</th><th>Executive</th><th>Q</th><th>Start</th><th>End</th><th>Status</th><th class="text-right">Revenue</th></tr></thead>
            <tbody id="tbl"></tbody>
          </table></div>
          <div class="pagination"><span id="pg-info"></span><div class="page-btns"><button class="page-btn" id="btn-p" onclick="changePage(-1)">← Prev</button><button class="page-btn" id="btn-n" onclick="changePage(1)">Next →</button></div></div>
        </div>`;

      new Chart(document.getElementById('qChart'),{type:'bar',data:{labels:['Q1','Q2','Q3','Q4'],datasets:[{data:Object.values(byQ),backgroundColor:['#7B42F6','#9D6FF8','#7B42F6','#9D6FF8'],borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#AAAAAA'},grid:{color:'#2A2A2A'}},y:{ticks:{color:'#AAAAAA',callback:v=>'$'+(v/1e6).toFixed(1)+'M'},grid:{color:'#2A2A2A'}}}}});
      new Chart(document.getElementById('sChart'),{type:'doughnut',data:{labels:Object.keys(byStatus),datasets:[{data:Object.values(byStatus),backgroundColor:['#22C55E','#EF4444','#F59E0B','#AAAAAA'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#AAAAAA',font:{size:12}}}}}});

      const maxRev=execSorted[0]?.[1].revenue||1;
      document.getElementById('exec-bars').innerHTML=execSorted.map(([n,d])=>`<div class="exec-row"><div class="exec-name" title="${n}">${n}</div><div class="exec-bar-wrap"><div class="exec-bar" style="width:${(d.revenue/maxRev*100).toFixed(1)}%"></div></div><div class="exec-rev">$${(d.revenue/1e6).toFixed(1)}M</div><div class="exec-cnt">${d.count} proj</div></div>`).join('');
      renderTable();
    }

    function renderTable() {
      const start=(currentPage-1)*PAGE_SIZE;
      const page=filteredRecords.slice(start,start+PAGE_SIZE);
      const total=filteredRecords.length;
      document.getElementById('tbl').innerHTML=page.map(r=>{
        const e=(r['Client Partner Name']||['—'])[0];
        const s=r['Main Project Status']||'N/A';
        const bc=s==='Finished'?'badge-finished':s==='Cancelled'?'badge-cancelled':'badge-na';
        const rev=r['Gross Sale (USD)']||0;
        return `<tr><td>${r['Campaign Name']||'—'}</td><td>${e}</td><td>${r.quarter}</td><td>${r['Campaign Start Date']||'—'}</td><td>${r['Campaign End Date']||'—'}</td><td><span class="badge ${bc}">${s}</span></td><td class="text-right text-purple">$${rev.toLocaleString()}</td></tr>`;
      }).join('');
      document.getElementById('pg-info').textContent=`${start+1}–${Math.min(start+PAGE_SIZE,total)} of ${total}`;
      document.getElementById('btn-p').disabled=currentPage===1;
      document.getElementById('btn-n').disabled=currentPage>=Math.ceil(total/PAGE_SIZE);
    }

    function changePage(d){currentPage+=d;renderTable();}
    loadData();
  </script>
</body>
</html>
